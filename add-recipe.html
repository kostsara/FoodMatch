<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ä–µ—Ü–µ–ø—Ç ‚Äì FoodMatch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* --- –°–¢–ò–õ–Ü (–ü–û–í–ï–†–ù–£–õ–ò –ì–ê–†–ù–ò–ô –î–ò–ó–ê–ô–ù) --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            background: #f5f5f7; 
            color: #111827; 
            line-height: 1.5; 
            padding-top: 80px; /* –í—ñ–¥—Å—Ç—É–ø –¥–ª—è —à–∞–ø–∫–∏ */
        }

        a { text-decoration: none; color: inherit; transition: 0.2s; }

        /* HEADER */
        header {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 1200px;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            border-radius: 99px; padding: 10px 24px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); z-index: 1000; border: 1px solid #e5e7eb;
        }
        .logo { font-weight: 800; font-size: 1.3rem; display: flex; align-items: center; gap: 8px; }
        .logo span { color: #f97316; } 
        
        .nav-center { display: flex; gap: 20px; }
        .nav-link { font-weight: 500; font-size: 0.9rem; color: #6b7280; }
        .nav-link:hover { color: #f97316; }
        .nav-link.active { color: #111827; font-weight: 700; }
        
        .btn-profile { 
            width: 40px; height: 40px; border-radius: 50%; background: #111827; 
            color: white; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }

        /* CONTAINER */
        .container { max-width: 800px; margin: 0 auto; padding: 0 20px 60px; }
        .page-title { font-size: 2rem; font-weight: 800; margin-bottom: 20px; text-align: center; }

        /* FORM CARD */
        .form-card { 
            background: white; border-radius: 24px; padding: 40px; 
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; 
        }

        .form-group { margin-bottom: 24px; }
        label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 8px; color: #374151; }
        
        input, select, textarea { 
            width: 100%; padding: 12px 16px; border-radius: 12px; 
            border: 1px solid #e5e7eb; background: #f9fafb; 
            font-size: 1rem; outline: none; font-family: inherit; transition: 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: #f97316; background: white; box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1); }

        /* UPLOAD AREA */
        .upload-area {
            border: 2px dashed #d1d5db; border-radius: 16px;
            padding: 30px; text-align: center; cursor: pointer; transition: 0.2s;
            background: #f9fafb; color: #6b7280;
        }
        .upload-area:hover { border-color: #f97316; background: #fff7ed; color: #c2410c; }
        
        /* PHOTO GRID */
        .photo-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px; margin-top: 15px;
        }
        .photo-item {
            position: relative; width: 100%; height: 100px; border-radius: 12px; overflow: hidden; border: 1px solid #e5e7eb;
        }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .photo-remove {
            position: absolute; top: 5px; right: 5px; width: 22px; height: 22px;
            background: rgba(0,0,0,0.6); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer;
        }
        .photo-remove:hover { background: #ef4444; }

        /* DYNAMIC ROWS */
        .row-item { display: grid; grid-template-columns: 1fr 100px 44px; gap: 10px; margin-bottom: 10px; }
        .step-item { display: grid; grid-template-columns: 30px 1fr 44px; gap: 10px; margin-bottom: 10px; align-items: start; }
        
        .step-num { font-weight: 800; color: #f97316; padding-top: 12px; font-size: 1.1rem; }
        
        .btn-remove {
            height: 46px; background: #fee2e2; color: #991b1b; border: none;
            border-radius: 12px; cursor: pointer; font-size: 1.2rem; transition: 0.2s;
        }
        .btn-remove:hover { background: #fecaca; }

        .btn-add {
            width: 100%; padding: 12px; border: 2px dashed #d1d5db; border-radius: 12px;
            background: transparent; color: #6b7280; font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .btn-add:hover { border-color: #f97316; color: #f97316; background: #fff7ed; }

        .actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 40px; align-items: center; }
        .btn-cancel { color: #6b7280; font-weight: 600; }
        .btn-cancel:hover { color: #111827; }
        
        .btn-submit {
            background: #111827; color: white; padding: 14px 32px; border-radius: 99px;
            font-weight: 600; border: none; cursor: pointer; font-size: 1rem;
            transition: 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .btn-submit:disabled { background: #9ca3af; cursor: not-allowed; }

        @media (max-width: 600px) {
            .nav-center { display: none; }
            .row-item { grid-template-columns: 1fr 70px 44px; }
        }
    </style>
</head>
<body>

    <header>
        <a href="index.html" class="logo">üçΩ Food<span>Match</span></a>
        <div class="nav-center">
            <a href="index.html" class="nav-link">–†–µ—Ü–µ–ø—Ç–∏</a>
            <a href="shopping-list.html" class="nav-link">–ü–æ–∫—É–ø–∫–∏</a>
            <a href="add-recipe.html" class="nav-link active">–î–æ–¥–∞—Ç–∏</a>
        </div>
        <a href="profile.html" class="btn-profile">üë§</a>
    </header>

    <div class="container">
        <h1 class="page-title">üç≥ –ù–æ–≤–∏–π —Ä–µ—Ü–µ–ø—Ç</h1>

        <form class="form-card" onsubmit="publishRecipe(event)">
            
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞ —Å—Ç—Ä–∞–≤–∏</label>
                <input type="text" id="rTitle" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ë–æ—Ä—â –∑ –ø–∞–º–ø—É—à–∫–∞–º–∏" required>
            </div>

            <div class="form-group">
                <label>–§–æ—Ç–æ —Å—Ç—Ä–∞–≤–∏ (–º–æ–∂–Ω–∞ –¥–µ–∫—ñ–ª—å–∫–∞)</label>
                <div class="upload-area" onclick="document.getElementById('rFiles').click()">
                    <div style="font-size: 2rem; margin-bottom: 5px;">üì∑</div>
                    <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± –¥–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</p>
                    <input type="file" id="rFiles" hidden multiple accept="image/*" onchange="handleFileSelect(this)">
                </div>
                <div class="photo-grid" id="previewContainer"></div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                <div>
                    <label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                    <select id="rCategory">
                        <option value="breakfast">–°–Ω—ñ–¥–∞–Ω–æ–∫</option>
                        <option value="lunch">–û–±—ñ–¥</option>
                        <option value="dinner">–í–µ—á–µ—Ä—è</option>
                        <option value="dessert">–î–µ—Å–µ—Ä—Ç</option>
                    </select>
                </div>
                <div>
                    <label>–ß–∞—Å (—Ö–≤–∏–ª–∏–Ω)</label>
                    <input type="number" id="rTime" placeholder="40" required>
                </div>
            </div>

            <div class="form-group">
                <label>–Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏</label>
                <div id="ingredientsList">
                    <div class="row-item">
                        <input type="text" class="ing-name" placeholder="–ù–∞–∑–≤–∞" required>
                        <input type="text" class="ing-amount" placeholder="–ö-—Å—Ç—å" required>
                        <button type="button" class="btn-remove" onclick="removeRow(this)">√ó</button>
                    </div>
                </div>
                <button type="button" class="btn-add" onclick="addIngredient()">+ –î–æ–¥–∞—Ç–∏ —â–µ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç</button>
            </div>

            <div class="form-group">
                <label>–Ø–∫ –≥–æ—Ç—É–≤–∞—Ç–∏?</label>
                <div id="stepsList">
                    <div class="step-item">
                        <div class="step-num">1</div>
                        <textarea class="step-desc" rows="2" placeholder="–û–ø–∏—à—ñ—Ç—å –ø–µ—Ä—à–∏–π –∫—Ä–æ–∫..." required></textarea>
                        <button type="button" class="btn-remove" onclick="removeRow(this)">√ó</button>
                    </div>
                </div>
                <button type="button" class="btn-add" onclick="addStep()">+ –î–æ–¥–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫</button>
            </div>

            <div class="actions">
                <a href="index.html" class="btn-cancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</a>
                <button type="submit" class="btn-submit" id="submitBtn">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ —Ä–µ—Ü–µ–ø—Ç</button>
            </div>
        </form>
    </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/db.js"></script>

    <script>
        let currentUser = null;
        let editRecipeId = null; // ID —Ä–µ—Ü–µ–ø—Ç–∞ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
        let existingPhotos = []; // –§–æ—Ç–æ, —è–∫—ñ –≤–∂–µ –±—É–ª–∏ –≤ —Ä–µ—Ü–µ–ø—Ç—ñ
        let newFiles = [];       // –ù–æ–≤—ñ —Ñ–æ—Ç–æ, —è–∫—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –¥–æ–¥–∞–≤ –∑–∞—Ä–∞–∑

        // 1. –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –ü–†–ò –°–¢–ê–†–¢–Ü
        document.addEventListener('DOMContentLoaded', async () => {
            // –ê. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤—Ö—ñ–¥
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = "login.html";
                return;
            }
            currentUser = user;

            // –ë. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ URL (—á–∏ —Ü–µ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è?)
            const params = new URLSearchParams(window.location.search);
            editRecipeId = params.get('id');

            if (editRecipeId) {
                // –†–ï–ñ–ò–ú –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø
                await loadRecipeForEdit(editRecipeId);
            } else {
                // –†–ï–ñ–ò–ú –°–¢–í–û–†–ï–ù–ù–Ø (–¥–æ–¥–∞—î–º–æ –ø–æ –æ–¥–Ω–æ–º—É –ø—É—Å—Ç–æ–º—É –ø–æ–ª—é)
                addIngredient();
                addStep();
            }
        });

        // 2. –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –î–ê–ù–ò–• –†–ï–¶–ï–ü–¢–ê
        async function loadRecipeForEdit(id) {
            // –ú—ñ–Ω—è—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —ñ –∫–Ω–æ–ø–∫—É
            document.querySelector('.page-title').textContent = "‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ä–µ—Ü–µ–ø—Ç";
            document.getElementById('submitBtn').textContent = "–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏";

            // –¢—è–≥–Ω–µ–º–æ –¥–∞–Ω—ñ –∑ –±–∞–∑–∏
            const { data: recipe, error } = await supabase
                .from('recipes')
                .select('*')
                .eq('id', id)
                .single();

            if (error) {
                alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–µ—Ü–µ–ø—Ç: " + error.message);
                return;
            }

            // –ó–∞–ø–æ–≤–Ω—é—î–º–æ –ø—Ä–æ—Å—Ç—ñ –ø–æ–ª—è
            document.getElementById('rTitle').value = recipe.title;
            document.getElementById('rCategory').value = recipe.category;
            document.getElementById('rTime').value = recipe.time_minutes;
            if(document.getElementById('rCalories')) document.getElementById('rCalories').value = recipe.calories || '';

            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ —Ñ–æ—Ç–æ (—è–∫—â–æ —î)
            if (recipe.image_url && Array.isArray(recipe.image_url)) {
                existingPhotos = recipe.image_url;
                renderAllPhotos();
            }

            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏
            const ingList = document.getElementById('ingredientsList');
            ingList.innerHTML = ''; // –ß–∏—Å—Ç–∏–º–æ –ø—É—Å—Ç—ñ –ø–æ–ª—è
            if (recipe.ingredients && Array.isArray(recipe.ingredients)) {
                recipe.ingredients.forEach(ing => addIngredient(ing.name, ing.amount));
            } else {
                addIngredient();
            }

            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –∫—Ä–æ–∫–∏
            const stepList = document.getElementById('stepsList');
            stepList.innerHTML = ''; // –ß–∏—Å—Ç–∏–º–æ
            if (recipe.steps && Array.isArray(recipe.steps)) {
                recipe.steps.forEach(step => addStep(step));
            } else {
                addStep();
            }
        }

        // 3. –õ–û–ì–Ü–ö–ê –§–û–¢–û (–í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø)
        function handleFileSelect(input) {
            const files = Array.from(input.files);
            newFiles = [...newFiles, ...files];
            renderAllPhotos();
        }

        function renderAllPhotos() {
            const container = document.getElementById('previewContainer');
            container.innerHTML = '';

            // –ú–∞–ª—é—î–º–æ –°–¢–ê–†–Ü —Ñ–æ—Ç–æ (–∑ –±–∞–∑–∏)
            existingPhotos.forEach((url, index) => {
                const div = createPhotoElement(url, true, index);
                container.appendChild(div);
            });

            // –ú–∞–ª—é—î–º–æ –ù–û–í–Ü —Ñ–æ—Ç–æ (–∑ –∫–æ–º–ø'—é—Ç–µ—Ä–∞)
            newFiles.forEach((file, index) => {
                const url = URL.createObjectURL(file);
                const div = createPhotoElement(url, false, index);
                container.appendChild(div);
            });
        }

        function createPhotoElement(src, isExisting, index) {
            const div = document.createElement('div');
            div.className = 'photo-item';
            div.innerHTML = `
                <img src="${src}">
                <div class="photo-remove" title="–í–∏–¥–∞–ª–∏—Ç–∏">√ó</div>
            `;
            
            // –õ–æ–≥—ñ–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø—Ä–∏ –∫–ª—ñ–∫—É –Ω–∞ —Ö—Ä–µ—Å—Ç–∏–∫
            div.querySelector('.photo-remove').onclick = () => {
                if (isExisting) {
                    existingPhotos.splice(index, 1); // –í–∏–¥–∞–ª—è—î–º–æ –∑—ñ —Å–ø–∏—Å–∫—É —Å—Ç–∞—Ä–∏—Ö
                } else {
                    newFiles.splice(index, 1); // –í–∏–¥–∞–ª—è—î–º–æ –∑—ñ —Å–ø–∏—Å–∫—É –Ω–æ–≤–∏—Ö
                }
                renderAllPhotos(); // –ü–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î–º–æ
            };
            return div;
        }


        // 4. –î–ò–ù–ê–ú–Ü–ß–ù–Ü –ü–û–õ–Ø (UI)
        function addIngredient(nameVal = '', amountVal = '') {
            const div = document.createElement('div');
            div.className = 'row-item';
            div.innerHTML = `
                <input type="text" class="auth-input ing-name" placeholder="–ù–∞–∑–≤–∞" value="${nameVal}" required>
                <input type="text" class="auth-input ing-amount" placeholder="–ö-—Å—Ç—å" value="${amountVal}" required>
                <button type="button" class="btn-remove" onclick="this.parentElement.remove()">√ó</button>
            `;
            document.getElementById('ingredientsList').appendChild(div);
        }

        function addStep(textVal = '') {
            const list = document.getElementById('stepsList');
            const count = list.children.length + 1;
            const div = document.createElement('div');
            div.className = 'step-item';
            div.innerHTML = `
                <div class="step-num">#</div>
                <textarea class="auth-input step-desc" rows="2" placeholder="–û–ø–∏—à—ñ—Ç—å –∫—Ä–æ–∫..." required>${textVal}</textarea>
                <button type="button" class="btn-remove" onclick="this.parentElement.remove()">√ó</button>
            `;
            list.appendChild(div);
        }


        // 5. –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø (CREATE –∞–±–æ UPDATE)
        async function publishRecipe(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...";

            try {
                // –ê. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ù–û–í–Ü —Ñ–æ—Ç–æ –≤ Storage
                let newPhotoUrls = [];
                for (const file of newFiles) {
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${currentUser.id}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
                    
                    const { error: uploadError } = await supabase.storage
                        .from('RECIPE_PHOTOS')
                        .upload(fileName, file);
                    
                    if (uploadError) throw uploadError;

                    const { data } = supabase.storage.from('RECIPE_PHOTOS').getPublicUrl(fileName);
                    newPhotoUrls.push(data.publicUrl);
                }

                // –û–±'—î–¥–Ω—É—î–º–æ —Å—Ç–∞—Ä—ñ (—â–æ –ª–∏—à–∏–ª–∏—Å—è) —ñ –Ω–æ–≤—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
                const finalImages = [...existingPhotos, ...newPhotoUrls];

                // –ë. –ó–±–∏—Ä–∞—î–º–æ –¥–∞–Ω—ñ —Ñ–æ—Ä–º–∏
                const ingredients = [];
                document.querySelectorAll('.row-item').forEach(row => {
                    const name = row.querySelector('.ing-name').value;
                    const amount = row.querySelector('.ing-amount').value;
                    if(name) ingredients.push({ name, amount });
                });

                const steps = [];
                document.querySelectorAll('.step-desc').forEach(el => {
                    if(el.value) steps.push(el.value);
                });

                const recipeData = {
                    author_id: currentUser.id,
                    title: document.getElementById('rTitle').value,
                    image_url: finalImages,
                    category: document.getElementById('rCategory').value,
                    time_minutes: parseInt(document.getElementById('rTime').value) || 0,
                    calories: document.getElementById('rCalories') ? parseInt(document.getElementById('rCalories').value) : 0,
                    ingredients: ingredients,
                    steps: steps
                };

                // –í. –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –≤ –±–∞–∑—É
                let result;
                if (editRecipeId) {
                    // –û–ù–û–í–õ–ï–ù–ù–Ø
                    result = await supabase.from('recipes').update(recipeData).eq('id', editRecipeId);
                } else {
                    // –°–¢–í–û–†–ï–ù–ù–Ø
                    result = await supabase.from('recipes').insert([recipeData]);
                }

                if (result.error) throw result.error;

                alert(editRecipeId ? "–†–µ—Ü–µ–ø—Ç –æ–Ω–æ–≤–ª–µ–Ω–æ!" : "–†–µ—Ü–µ–ø—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ!");
                window.location.href = "profile.html";

            } catch (error) {
                alert("–ü–æ–º–∏–ª–∫–∞: " + error.message);
                btn.disabled = false;
                btn.textContent = editRecipeId ? "–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏" : "–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏";
            }
        }
    </script>
</body>
</html>