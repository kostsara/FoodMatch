<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <title>–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å ‚Äì FoodMatch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- –®—Ä–∏—Ñ—Ç -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #A10404;
            --primary-hover: #7c0303;
            --bg-body: #f3f4f6;
            --surface: #ffffff;
            --text-main: #111827;
            --text-light: #6B7280;
            --border: #E5E7EB;
            --radius: 20px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: url('img/background.jpg') center/cover no-repeat fixed;
            color: var(--text-main);
            line-height: 1.5;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        input,
        textarea,
        select {
            font-family: inherit;
        }

        button {
            font-family: inherit;
            cursor: pointer;
        }

        /* HEADER */
        header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e5e7eb;
            height: 70px;
            display: flex;
            align-items: center;
        }

        .nav {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            font-weight: 800;
            font-size: 1.4rem;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .nav-links-center {
            display: flex;
            gap: 20px;
        }

        .nav-links-center a {
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #111827;
        }

        .nav-links-center a:hover {
            color: var(--primary);
        }

        .nav-links-center a.active {
            color: var(--primary);
        }

        .nav-btn {
            border-radius: 999px;
            background: var(--primary);
            border: 1px solid var(--primary);
            color: #fff;
            padding: 8px 18px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            transition: 0.2s;
        }

        .nav-btn:hover {
            transform: translateY(-1px);
            background: var(--primary-hover);
            border-color: var(--primary-hover);
            box-shadow: 0 4px 12px rgba(161, 4, 4, 0.35);
        }

        button:focus,
        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 1px rgba(161, 4, 4, 0.12);
        }

        /* LAYOUT */
        .container {
            max-width: 1100px;
            margin: 30px auto 60px;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 30px;
            align-items: start;
        }

        @media (max-width: 850px) {
            .container {
                grid-template-columns: 1fr;
            }

            .nav-links-center {
                display: none;
            }
        }

        /* SIDEBAR */
        .profile-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 30px 20px;
            text-align: center;
            border: 1px solid var(--border);
            position: sticky;
            top: 100px;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.06);
        }

        .avatar-box {
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
            border-radius: 50%;
            background: #FFF7ED;
            border: 4px solid #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            line-height: 1;
            color: #4B5563;
            font-weight: 700;
        }

        .avatar-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-name {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 2px;
        }

        .user-nick {
            font-size: 0.95rem;
            color: var(--text-light);
            margin-bottom: 15px;
            font-weight: 500;
        }

        .user-bio {
            font-size: 0.9rem;
            color: #4B5563;
            margin-bottom: 20px;
            font-style: italic;
            background: #F9FAFB;
            padding: 10px;
            border-radius: 10px;
            word-wrap: break-word;
        }

        .sidebar-socials {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 25px;
        }

        .social-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #F3F4F6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1F2937;
            transition: 0.2s;
        }

        .social-icon:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .social-icon.hidden {
            display: none;
        }

        .level-box {
            text-align: left;
            padding: 15px;
            background: #FFF7ED;
            border-radius: 12px;
            border: 1px solid #FFEDD5;
            margin-bottom: 20px;
        }

        .level-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: #9A3412;
        }

        .progress-bar {
            height: 8px;
            background: #FED7AA;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 1s ease;
        }

        .profile-menu {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 5px;
        }

        .menu-btn {
            background: none;
            border: none;
            padding: 12px 16px;
            border-radius: 10px;
            text-align: left;
            cursor: pointer;
            font-size: 0.95rem;
            color: #4B5563;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.1s;
        }

        .menu-btn:hover {
            background: #F3F4F6;
            color: #111827;
        }

        .menu-btn.active {
            background: #111827;
            color: white;
        }

        .menu-btn.logout {
            color: #EF4444;
            margin-top: 10px;
            border-top: 1px solid #F3F4F6;
            border-radius: 0;
        }

        .menu-btn.logout:hover {
            background: #FEF2F2;
        }

        /* MAIN CONTENT */
        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        .settings-box {
            background: var(--surface);
            padding: 32px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.05);
        }

        .section-title-main {
            font-size: 1rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: #111827;
            margin-bottom: 18px;
        }

        .form-section-title {
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #9CA3AF;
            margin-bottom: 15px;
            margin-top: 25px;
        }

        .form-section-title:first-child {
            margin-top: 0;
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }

        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: 0.2s;
            background: #FFF7ED;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            user-select: none;
        }

        .avatar-option:hover {
            transform: scale(1.1);
            background: #FFEDD5;
        }

        .avatar-option.selected {
            border-color: var(--primary);
            background: #FFF7ED;
            box-shadow: 0 0 0 3px rgba(161, 4, 4, 0.2);
            transform: scale(1.05);
        }

        .upload-btn-grid {
            border: 2px dashed #D1D5DB;
            background: #ffffff;
            color: #9CA3AF;
            font-size: 1.5rem;
        }

        .upload-btn-grid:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .input-wrapper {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 14px;
            top: 12px;
            color: #9CA3AF;
            font-size: 1.1rem;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
            font-size: 1rem;
            outline: none;
            background: #FFFFFF;
            transition: 0.2s;
        }

        .with-icon {
            padding-left: 44px;
        }

        input:focus,
        textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(161, 4, 4, 0.1);
        }

        .social-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 850px) {
            .profile-card {
                position: static;
                margin-bottom: 20px;
            }

            .social-grid {
                grid-template-columns: 1fr;
            }
        }

        .btn-main {
            background: #111827;
            color: #fff;
            padding: 12px 40px;
            border-radius: 999px;
            border: none;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-main:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .btn-save {
            background: var(--primary);
            color: #fff;
            padding: 12px 40px;
            border-radius: 999px;
            border: none;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 4px 15px rgba(161, 4, 4, 0.35);
        }

        .btn-save:hover {
            transform: translateY(-1px);
            background: var(--primary-hover);
            box-shadow: 0 8px 22px rgba(161, 4, 4, 0.45);
        }

        /* GRID –î–õ–Ø –†–ï–¶–ï–ü–¢–Ü–í */
        .recipes-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }

        /* –°–¢–ê–†–Ü –ú–Ü–ù–Ü-–ö–ê–†–¢–ö–ò (–ú–û–á –†–ï–¶–ï–ü–¢–ò) */
        .recipe-mini {
            background: white;
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }

        .recipe-mini:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.06);
        }

        .rm-img {
            height: 140px;
            background: #FFEDD5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            background-size: cover;
            background-position: center;
            color: #4B5563;
        }

        .rm-body {
            padding: 14px;
        }

        .rm-title {
            font-weight: 700;
            margin-bottom: 4px;
            font-size: 1rem;
        }

        .rm-meta {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .rm-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .rm-btn {
            flex: 1;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            padding: 8px;
            text-align: center;
            background: #F3F4F6;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #374151;
            border: none;
        }

        .rm-btn:hover {
            background: #E5E7EB;
        }

        .rm-btn-delete {
            background: #FEF2F2;
            color: #B91C1C;
        }

        .rm-btn-delete:hover {
            background: #FEE2E2;
        }

        /* –ö–ê–†–¢–ö–ò –Ø–ö –ù–ê –ì–û–õ–û–í–ù–Ü (–ó–ë–ï–†–ï–ñ–ï–ù–Ü + –†–ï–¶–ï–ü–¢–ò –ö–û–†–ò–°–¢–£–í–ê–ß–ê) */
        .recipe-card {
            border-radius: 20px;
            border: 1px solid #e5e7eb;
            background: #fff;
            overflow: hidden;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.08);
        }

        .recipe-img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .card-heart-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 5;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            color: #d1d5db;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .card-heart-btn:hover {
            transform: scale(1.1);
            background: white;
        }

        .card-heart-btn.saved {
            color: #A10404;
            border-color: #A10404;
            background: #fdf2f2;
        }

        .card-content {
            padding: 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .recipe-title {
            font-weight: 700;
            font-size: 1.05rem;
            line-height: 1.3;
        }

        .recipe-meta {
            display: flex;
            gap: 12px;
            font-size: 0.8rem;
            color: #6b7280;
        }

        .meta-tags-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }

        .tag {
            border-radius: 99px;
            padding: 4px 10px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .tag-good {
            background: #dcfce7;
            color: #166534;
        }

        .tag-missing {
            background: #A10404;
            color: #ffffff;
        }

        .tag-feature,
        .tag-spice {
            background: #f3f4f6;
            color: #111827;
        }

        /* –°–µ—Ä–¥–µ—á–∫–æ —É ‚Äú—Å—Ç–∞—Ä–æ–º—É‚Äù —Å—Ç–∏–ª—ñ (—è –ª–∏—à–∞—é —è–∫ –∑–∞–ø–∞—Å–Ω–∏–π, –∞–ª–µ –º–∏ –π–æ–≥–æ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ) */
        .mini-heart-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #E5E7EB;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #D1D5DB;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s;
            z-index: 5;
        }

        .mini-heart-btn:hover {
            transform: scale(1.05);
            background: #ffffff;
        }

        .mini-heart-btn.saved {
            color: var(--primary);
            border-color: var(--primary);
            background: #FEF2F2;
        }

        /* MODAL ‚Äì —è–∫ –Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(4px);
        }

        .modal-backdrop.show {
            display: flex;
        }

        .modal {
            background: #fff;
            border-radius: 24px;
            width: 90%;
            max-width: 650px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 800;
        }

        .btn-heart {
            background: #f3f4f6;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            color: #d1d5db;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-heart:hover,
        .btn-heart.saved {
            background: #fdf2f2;
            color: #A10404;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
        }

        .gallery-container {
            position: relative;
            width: 100%;
            height: 300px;
            margin-bottom: 20px;
            border-radius: 16px;
            overflow: hidden;
            background: #ffffff;
        }

        .modal-gallery {
            display: flex;
            width: 100%;
            height: 100%;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            scrollbar-width: none;
        }

        .modal-gallery::-webkit-scrollbar {
            display: none;
        }

        .modal-gallery img {
            min-width: 100%;
            height: 100%;
            object-fit: contain;
            scroll-snap-align: start;
            background: #ffffff;
        }

        .gallery-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(5px);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            transition: 0.2s;
        }

        .g-prev {
            left: 10px;
        }

        .g-next {
            right: 10px;
        }

        .author-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .author-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: block;
        }

        .author-info {
            display: flex;
            flex-direction: column;
            line-height: 1.3;
        }

        .author-label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 700;
        }

        .author-link {
            font-weight: 700;
            color: #111827;
            font-size: 0.95rem;
        }

        .author-link:hover {
            color: #A10404;
            text-decoration: underline;
        }

        .reviews-section {
            margin-top: 30px;
            border-top: 1px solid #e5e7eb;
            padding-top: 20px;
        }

        .review-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            background: #f9fafb;
            padding: 15px;
            border-radius: 12px;
        }

        .review-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            resize: none;
            font-family: inherit;
        }

        .star-rating {
            display: flex;
            gap: 5px;
            cursor: pointer;
            font-size: 1.5rem;
            color: #e5e7eb;
        }

        .star-rating span:hover,
        .star-rating span.active {
            color: #fbbf24;
        }

        .review-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #e5e7eb;
        }

        .review-author {
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .review-text {
            font-size: 0.9rem;
            color: #4b5563;
            margin-top: 4px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <header>
        <nav class="nav">
            <a href="index.html" class="logo">
                <img src="img/logo.jpg" alt="FoodMatch logo" class="logo-icon">
                <div>FoodMatch</div>
            </a>
            <div class="nav-links-center">
                <a href="add-recipe.html">–î–æ–¥–∞—Ç–∏ —Ä–µ—Ü–µ–ø—Ç</a>
                <a href="shopping-list.html">–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</a>
            </div>
            <div class="nav-actions">
                <a href="index.html" class="nav-btn" id="topNavBtn">–ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
            </div>
        </nav>
    </header>

    <div class="container">
        <aside>
            <div class="profile-card">
                <div class="avatar-box" id="sidebarAvatar">FM</div>

                <div class="user-name" id="sidebarName">...</div>
                <div class="user-nick" id="sidebarNick">@...</div>
                <div class="user-bio" id="sidebarBio"></div>

                <div class="sidebar-socials">
                    <a href="#" target="_blank" class="social-icon hidden" id="linkInsta" title="Instagram">
                        <i class="fa-brands fa-instagram" style="font-size: 1.3rem;"></i>
                    </a>
                    <a href="#" target="_blank" class="social-icon hidden" id="linkTiktok" title="TikTok">
                        <i class="fa-brands fa-tiktok" style="font-size: 1.2rem;"></i>
                    </a>
                    <a href="#" target="_blank" class="social-icon hidden" id="linkTelegram" title="Telegram">
                        <i class="fa-brands fa-telegram" style="font-size: 1.3rem;"></i>
                    </a>
                </div>

                <div class="level-box">
                    <div class="level-header">
                        <span id="levelName">–ù–æ–≤–∞—á–æ–∫</span>
                        <span id="levelXP">0 / 1000 XP</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="levelFill"></div>
                    </div>
                    <div id="xpText" style="font-size:0.75rem; color:#9ca3af; margin-top:5px; text-align:center;"></div>
                </div>

                <div class="profile-menu">
                    <button id="btnSettings" class="menu-btn active"
                        onclick="openTab('settings', this)">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
                    <button id="btnMyRecipes" class="menu-btn" onclick="openTab('my-recipes', this)">–ú–æ—ó
                        —Ä–µ—Ü–µ–ø—Ç–∏</button>
                    <button id="btnSaved" class="menu-btn" onclick="openTab('saved', this)">–ó–±–µ—Ä–µ–∂–µ–Ω—ñ</button>
                    <button class="menu-btn logout" onclick="logout()">–í–∏–π—Ç–∏</button>
                </div>
            </div>
        </aside>

        <main>
            <div id="settings" class="content-section active">
                <h1 class="section-title-main">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</h1>

                <div class="settings-box">
                    <form onsubmit="saveProfile(event)">
                        <div class="form-section-title">–û–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∞–±–æ —Ñ–æ—Ç–æ</div>

                        <div class="avatar-grid" id="avatarSelector">
                            <div class="avatar-option upload-btn-grid"
                                onclick="document.getElementById('fileInput').click()" title="–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–≤–æ—î —Ñ–æ—Ç–æ">
                                üì∑
                            </div>
                        </div>
                        <input type="file" id="fileInput" hidden accept="image/*" onchange="uploadCustomAvatar(this)">
                        <input type="hidden" id="inputAvatarUrl">

                        <div class="form-section-title">–û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</div>

                        <div class="social-grid">
                            <div class="form-group">
                                <label>–í–∞—à–µ —ñ–º'—è</label>
                                <input type="text" id="inputName" placeholder="–û–ª–µ–∫—Å—ñ–π" required>
                            </div>
                            <div class="form-group">
                                <label>–ù—ñ–∫–Ω–µ–π–º (–±–µ–∑ @)</label>
                                <div class="input-wrapper">
                                    <span class="input-icon">@</span>
                                    <input type="text" id="inputNick" class="with-icon" placeholder="alex_cook">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>–ü—Ä–æ —Å–µ–±–µ</label>
                            <textarea id="inputBio" rows="3"
                                placeholder="–†–æ–∑–∫–∞–∂—ñ—Ç—å –ø—Ä–æ —Å–≤–æ—ó –∫—É–ª—ñ–Ω–∞—Ä–Ω—ñ –≤–ø–æ–¥–æ–±–∞–Ω–Ω—è..."></textarea>
                        </div>

                        <div class="form-section-title">–°–æ—Ü—ñ–∞–ª—å–Ω—ñ –º–µ—Ä–µ–∂—ñ</div>

                        <div class="social-grid">
                            <div class="form-group">
                                <label>Instagram</label>
                                <div class="input-wrapper">
                                    <input type="text" id="inputInsta" placeholder="https://instagram.com/...">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>TikTok</label>
                                <div class="input-wrapper">
                                    <input type="text" id="inputTiktok" placeholder="https://tiktok.com/...">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Telegram</label>
                                <div class="input-wrapper">
                                    <input type="text" id="inputTelegram" placeholder="https://t.me/...">
                                </div>
                            </div>
                        </div>

                        <div style="text-align: right; margin-top: 20px;">
                            <button type="submit" class="btn-save">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="my-recipes" class="content-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:18px;">
                    <h1 id="myRecipesTitle" class="section-title-main" style="margin-bottom:0;">–ú–æ—ó —Ä–µ—Ü–µ–ø—Ç–∏</h1>
                    <a id="btnCreateRecipe" href="add-recipe.html" class="btn-main"
                        style="padding:10px 22px; font-size:0.8rem;">
                        –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ä–µ—Ü–µ–ø—Ç
                    </a>
                </div>
                <div class="settings-box" style="padding:20px;">
                    <div class="recipes-list" id="myRecipesGrid">
                        <p style="color:#6b7280;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
                    </div>
                </div>
            </div>

            <div id="saved" class="content-section">
                <h1 class="section-title-main">–ó–±–µ—Ä–µ–∂–µ–Ω—ñ</h1>
                <div class="settings-box" style="padding:20px;">
                    <div class="recipes-list" id="savedRecipesGrid">
                        <p style="color:#6b7280;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ—Ü–µ–ø—Ç–∞ —è–∫ –Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π -->
    <div class="modal-backdrop" id="recipeModal">
        <div class="modal">
            <div class="modal-header">
                <div style="display:flex; align-items:center; gap:15px; flex:1;">
                    <div class="modal-title" id="mTitle"></div>
                    <button id="btnSaveModal" class="btn-heart" title="–ó–±–µ—Ä–µ–≥—Ç–∏">‚ô•</button>
                </div>
                <button onclick="closeModal()"
                    style="border:none; background:none; font-size:2rem; color:#9ca3af; cursor:pointer;">&times;
                </button>
            </div>
            <div class="modal-body">
                <div class="gallery-container" id="galleryContainer">
                    <button class="gallery-btn g-prev" id="btnPrev" onclick="scrollGallery(-1)">&#10094;</button>
                    <button class="gallery-btn g-next" id="btnNext" onclick="scrollGallery(1)">&#10095;</button>
                    <div id="mGallery" class="modal-gallery"></div>
                </div>

                <div id="mAuthor" class="author-row" style="display:none;"></div>

                <div style="display:flex; flex-wrap:wrap; gap:20px; margin-bottom:10px; font-size:0.95rem; color:#4b5563;">
                    <span id="mTime"></span>
                    <span id="mCal"></span>
                    <span id="mMacros"></span> <!-- —Ç—É—Ç –±—É–¥—É—Ç—å –±—ñ–ª–∫–∏/–∂–∏—Ä–∏/–≤—É–≥–ª–µ–≤–æ–¥–∏ -->
                </div>


                <div id="mMetaTags" class="meta-tags-row" style="margin-bottom:25px;"></div>

                <h3 style="font-size:1.1rem; margin-bottom:15px;">–Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏</h3>
                <ul id="mIng" style="margin-bottom:30px; padding-left:20px; list-style:none;"></ul>

                <h3 style="font-size:1.1rem; margin-bottom:15px;">–ü—Ä–∏–≥–æ—Ç—É–≤–∞–Ω–Ω—è</h3>
                <ol id="mSteps" style="padding-left:20px; font-size:1rem; line-height:1.7; color:#374151;"></ol>

                <div class="reviews-section">
                    <h3 class="section-label" style="margin-bottom:15px;">–í—ñ–¥–≥—É–∫–∏ —Ç–∞ –æ—Ü—ñ–Ω–∫–∏</h3>
                    <div class="review-form">
                        <div class="star-rating" id="starRating">
                            <span data-val="1">‚òÖ</span><span data-val="2">‚òÖ</span><span data-val="3">‚òÖ</span><span
                                data-val="4">‚òÖ</span><span data-val="5">‚òÖ</span>
                        </div>
                        <textarea id="reviewText" rows="2" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å, —è–∫ –≤–∞–º —Å—Ç—Ä–∞–≤–∞..."></textarea>
                        <button onclick="sendReview()" class="pill-btn active"
                            style="width:100%; background:#A10404; border-color:#A10404; color:white;">
                            –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—ñ–¥–≥—É–∫
                        </button>
                    </div>
                    <div id="reviewsList"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/db.js"></script>

    <script>
        // 1. –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
        const EMOJI_AVATARS = ['üë®‚Äçüç≥', 'üë©‚Äçüç≥', 'üçî', 'üçï', 'ü•ó', 'ü•ë', 'ü•¶', 'üçì', 'üç©', 'ü•ê', '‚òï', 'üç±'];

        let currentUser = null;      // –æ–±'—î–∫—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        let currentUserId = null;    // id –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–æ–≥–æ
        let viewedUserId = null;     // —á–∏–π –ø—Ä–æ—Ñ—ñ–ª—å –¥–∏–≤–∏–º–æ—Å—å
        let isOwnProfile = true;     // —Å–≤—ñ–π —á–∏ —á—É–∂–∏–π

        let savedRecipeIds = new Set(); // id —Ä–µ—Ü–µ–ø—Ç—ñ–≤, —è–∫—ñ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –ø–æ—Ç–æ—á–Ω–∏–º —é–∑–µ—Ä–æ–º
        let currentRecipeId = null;     // id —Ä–µ—Ü–µ–ø—Ç–∞, –≤—ñ–¥–∫—Ä–∏—Ç–æ–≥–æ –≤ –º–æ–¥–∞–ª—Ü—ñ
        let currentRating = 0;          // —Ä–µ–π—Ç–∏–Ω–≥ —É –∑—ñ—Ä–æ—á–∫–∞—Ö

        const profileRecipesMap = new Map(); // id ‚Üí —Ä–µ—Ü–µ–ø—Ç (–¥–ª—è –º–æ–¥–∞–ª–∫–∏)

        // XP —Å–∏—Å—Ç–µ–º–∞
        const LEVEL_RANGE = 1000;
        const LEVEL_NAMES = ["–ù–æ–≤–∞—á–æ–∫", "–õ—é–±–∏—Ç–µ–ª—å", "–°—É-—à–µ—Ñ", "–®–µ—Ñ", "–õ–µ–≥–µ–Ω–¥–∞"];

        // –¢–µ–≥–∏ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç–µ–π
        const FEATURE_LABELS = {
            is_vegan: '–í–µ–≥–∞–Ω—Å—å–∫–µ',
            is_vegetarian: '–í–µ–≥–µ—Ç–∞—Ä—ñ–∞–Ω—Å—å–∫–µ',
            lactose_free: '–ë–µ–∑ –ª–∞–∫—Ç–æ–∑–∏',
            is_gluten_free: '–ë–µ–∑ –≥–ª—é—Ç–µ–Ω—É',
            pescetarian: '–ü–µ—Å–∫–µ—Ç–∞—Ä—ñ–∞–Ω—Å—å–∫–µ',
            nut_free: '–ë–µ–∑ –≥–æ—Ä—ñ—Ö—ñ–≤',
            citrus_free: '–ë–µ–∑ —Ü–∏—Ç—Ä—É—Å–æ–≤–∏—Ö'
        };

        function getRecipeFeaturesProfile(r) {
            return Object.keys(FEATURE_LABELS).filter(key => r[key]);
        }

        function spiceLabelProfile(val) {
            if (val === 'none') return '–ù–µ –≥–æ—Å—Ç—Ä–µ';
            if (val === 'medium') return '–°–µ—Ä–µ–¥–Ω—å–æ –≥–æ—Å—Ç—Ä–µ';
            if (val === 'hot') return '–ì–æ—Å—Ç—Ä–µ';
            return null;
        }

        // –ê–≤–∞—Ç–∞—Ä–∫–∏
        function initAvatarSelector(currentUrl) {
            const container = document.getElementById('avatarSelector');
            while (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }
            EMOJI_AVATARS.forEach(emoji => {
                const div = document.createElement('div');
                div.className = 'avatar-option';
                div.textContent = emoji;
                if (currentUrl === emoji) div.classList.add('selected');
                div.onclick = () => {
                    selectAvatar(emoji);
                    document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
                    document.querySelector('.upload-btn-grid').classList.remove('selected');
                    div.classList.add('selected');
                };
                container.appendChild(div);
            });
        }

        function selectAvatar(value) {
            const inputAvatar = document.getElementById('inputAvatarUrl');
            if (inputAvatar) inputAvatar.value = value;
            const sidebarAvatar = document.getElementById('sidebarAvatar');
            if (value.startsWith('http')) {
                sidebarAvatar.innerHTML = `<img src="${value}" style="width:100%; height:100%; object-fit:cover;">`;
            } else {
                sidebarAvatar.innerHTML = value;
            }
        }

        // 2. –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –ü–†–û–§–Ü–õ–Æ
        async function loadProfile() {
            const params = new URLSearchParams(window.location.search);
            const foreignId = params.get('id');

            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = "login.html";
                return;
            }

            currentUser = user;
            currentUserId = user.id;

            if (foreignId && foreignId !== user.id) {
                viewedUserId = foreignId;
                isOwnProfile = false;
            } else {
                viewedUserId = user.id;
                isOwnProfile = true;
            }

            // –ö–Ω–æ–ø–∫–∞ –≤ —Ö–µ–¥–µ—Ä—ñ
            const topNavBtn = document.getElementById('topNavBtn');
            if (topNavBtn) {
                if (isOwnProfile) {
                    topNavBtn.textContent = '–ù–∞ –≥–æ–ª–æ–≤–Ω—É';
                    topNavBtn.href = 'index.html';
                } else {
                    topNavBtn.textContent = '–ø—Ä–æ—Ñ—ñ–ª—å';
                    topNavBtn.href = 'profile.html';
                }
            }

            // –ü—Ä–æ—Ñ—ñ–ª—å
            const { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', viewedUserId)
                .single();

            if (!profile) {
                document.getElementById('sidebarName').textContent = "–ü—Ä–æ—Ñ—ñ–ª—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ";
                return;
            }

            document.getElementById('sidebarName').textContent = profile.full_name || "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á";
            document.getElementById('sidebarNick').textContent = profile.username ? `@${profile.username}` : "@...";
            document.getElementById('sidebarBio').textContent = profile.about || "–ù–∞–ø–∏—à—ñ—Ç—å –ø—Ä–æ —Å–µ–±–µ...";

            const avatar = profile.avatar_url || 'FM';
            selectAvatar(avatar);

            updateSocial('linkInsta', profile.instagram);
            updateSocial('linkTiktok', profile.tiktok);
            updateSocial('linkTelegram', profile.telegram);

            if (isOwnProfile) {
                document.getElementById('inputName').value = profile.full_name || "";
                document.getElementById('inputNick').value = profile.username || "";
                document.getElementById('inputBio').value = profile.about || "";
                document.getElementById('inputInsta').value = profile.instagram || "";
                document.getElementById('inputTiktok').value = profile.tiktok || "";
                document.getElementById('inputTelegram').value = profile.telegram || "";
                document.getElementById('inputAvatarUrl').value = avatar;

                initAvatarSelector(avatar);
            } else {
                const btnSettings = document.getElementById('btnSettings');
                const btnSaved = document.getElementById('btnSaved');
                const tabSettings = document.getElementById('settings');
                const tabSaved = document.getElementById('saved');
                const btnCreate = document.getElementById('btnCreateRecipe');
                const title = document.getElementById('myRecipesTitle');
                const logoutBtn = document.querySelector('.menu-btn.logout');
                const btnMyRecipes = document.getElementById('btnMyRecipes');

                if (btnSettings) btnSettings.style.display = 'none';
                if (tabSettings) tabSettings.style.display = 'none';

                if (btnSaved) btnSaved.style.display = 'none';
                if (tabSaved) tabSaved.style.display = 'none';

                if (btnCreate) btnCreate.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'none';

                if (title) title.textContent = '–†–µ—Ü–µ–ø—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞';
                if (btnMyRecipes) btnMyRecipes.textContent = '–†–µ—Ü–µ–ø—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞';

                document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                if (btnMyRecipes) btnMyRecipes.classList.add('active');
                document.getElementById('my-recipes').classList.add('active');
            }

            // XP
            updateLevel(profile.xp || 0);

            // –°–ø–æ—á–∞—Ç–∫—É —Ç—è–≥–Ω–µ–º–æ, —â–æ –≤–∂–µ –∑–±–µ—Ä–µ–∂–µ–Ω–æ
            await fetchSavedRecipesForProfile();

            // –†–µ—Ü–µ–ø—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            await loadUserRecipes(viewedUserId);

            // –ó–±–µ—Ä–µ–∂–µ–Ω—ñ ‚Äì —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Å–≤—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å
            if (isOwnProfile) {
                await loadSavedRecipes(currentUserId);
            } else {
                const savedContainer = document.getElementById('savedRecipesGrid');
                if (savedContainer) {
                    savedContainer.innerHTML =
                        '<p style="color:#9ca3af;">–ó–±–µ—Ä–µ–∂–µ–Ω—ñ —Ä–µ—Ü–µ–ø—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ –¥–ª—è —á—É–∂–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é.</p>';
                }
            }

            // –ó—ñ—Ä–æ—á–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥—É
            const stars = document.querySelectorAll('#starRating span');
            stars.forEach(star => {
                star.addEventListener('click', () => {
                    currentRating = Number(star.dataset.val);
                    stars.forEach(s =>
                        s.classList.toggle('active', Number(s.dataset.val) <= currentRating)
                    );
                });
            });
        }

        function updateSocial(id, url) {
            const el = document.getElementById(id);
            if (url && url.length > 5) {
                el.href = url;
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }

        // –ê–≤–∞—Ç–∞—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        async function uploadCustomAvatar(input) {
            const file = input.files[0];
            if (!file) return;
            document.body.style.cursor = 'wait';

            const { data: { user } } = await supabase.auth.getUser();
            const fileExt = file.name.split('.').pop();
            const fileName = `${user.id}-${Date.now()}.${fileExt}`;

            const { error } = await supabase.storage.from('AVATARS').upload(fileName, file);

            if (!error) {
                const { data } = supabase.storage.from('AVATARS').getPublicUrl(fileName);
                selectAvatar(data.publicUrl);
                document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
                document.querySelector('.upload-btn-grid').classList.add('selected');
            } else {
                alert("–ü–æ–º–∏–ª–∫–∞: " + error.message);
            }
            document.body.style.cursor = 'default';
        }

        // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é
        async function saveProfile(e) {
            e.preventDefault();
            const { data: { user } } = await supabase.auth.getUser();

            const updates = {
                id: user.id,
                full_name: document.getElementById('inputName').value,
                username: document.getElementById('inputNick').value || null,
                about: document.getElementById('inputBio').value || null,
                instagram: document.getElementById('inputInsta').value || null,
                tiktok: document.getElementById('inputTiktok').value || null,
                telegram: document.getElementById('inputTelegram').value || null,
                avatar_url: document.getElementById('inputAvatarUrl').value,
                updated_at: new Date()
            };

            const { error } = await supabase.from('profiles').upsert(updates);
            if (!error) {
                alert("–ó–º—ñ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ.");
                loadProfile();
            } else {
                alert(error.message);
            }
        }

        // 3. –ó–±–µ—Ä–µ–∂–µ–Ω—ñ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —é–∑–µ—Ä–∞ (–¥–ª—è —Å–µ—Ä–¥–µ—Ü—å)
        async function fetchSavedRecipesForProfile() {
            if (!currentUserId) return;
            const { data, error } = await supabase
                .from('saved_recipes')
                .select('recipe_id')
                .eq('user_id', currentUserId);

            if (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö:', error.message);
                return;
            }

            savedRecipeIds = new Set((data || []).map(row => row.recipe_id));
        }

        // 4. –†–µ—Ü–µ–ø—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        async function loadUserRecipes(uid) {
            const { data: recipes, error } = await supabase
                .from('recipes')
                .select('*')
                .eq('author_id', uid)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ—Ü–µ–ø—Ç—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:', error.message);
            }

            const container = document.getElementById('myRecipesGrid');
            const safeRecipes = recipes || [];
            safeRecipes.forEach(r => {
                if (r) profileRecipesMap.set(r.id, r);
            });

            renderRecipeList(safeRecipes, container, isOwnProfile, false);
        }

        // 5. –ó–±–µ—Ä–µ–∂–µ–Ω—ñ —Ä–µ—Ü–µ–ø—Ç–∏
        async function loadSavedRecipes(uid) {
            const { data: saved, error } = await supabase
                .from('saved_recipes')
                .select('recipe_id, recipes(*)')
                .eq('user_id', uid);

            const container = document.getElementById('savedRecipesGrid');

            if (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö:', error.message);
                container.innerHTML = '<p style="color:#9ca3af;">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.</p>';
                return;
            }

            if (saved && saved.length > 0) {
                const recipes = saved.map(item => item.recipes).filter(Boolean);
                recipes.forEach(r => profileRecipesMap.set(r.id, r));
                renderRecipeList(recipes, container, false, true);
            } else {
                container.innerHTML = '<p style="color:#9ca3af;">–ü–æ–∫–∏ —â–æ –ø—É—Å—Ç–æ.</p>';
            }
        }

        // 6. –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫—ñ–≤
        // isEditable = —Å–≤—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å ‚Üí –º—ñ–Ω—ñ-–∫–∞—Ä—Ç–∫–∏ –∑ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è–º
        // isSavedList = –≤–∫–ª–∞–¥–∫–∞ ‚Äú–ó–±–µ—Ä–µ–∂–µ–Ω—ñ‚Äù
        function renderRecipeList(recipes, container, isEditable, isSavedList = false) {
            container.innerHTML = '';
            if (!recipes || !recipes.length) {
                container.innerHTML = '<p style="color:#9ca3af;">–ü–æ–∫–∏ —â–æ –ø—É—Å—Ç–æ.</p>';
                return;
            }

            recipes.forEach(r => {
                if (!r) return;
                profileRecipesMap.set(r.id, r);

                let img = '';
                if (r.image_url) {
                    if (Array.isArray(r.image_url) && r.image_url.length > 0) img = r.image_url[0];
                    else if (typeof r.image_url === 'string') img = r.image_url;
                }

                // –í–∏–ø–∞–¥–æ–∫ 1: –ó–±–µ—Ä–µ–∂–µ–Ω—ñ –∞–±–æ —á—É–∂–∏–π –ø—Ä–æ—Ñ—ñ–ª—å ‚Üí –ö–ê–†–¢–ö–ê –Ø–ö –ù–ê –ì–û–õ–û–í–ù–Ü
                if (isSavedList || !isEditable) {
                    const card = document.createElement('article');
                    card.className = 'recipe-card';
                    card.dataset.id = r.id;

                    const bgStyle = img
                        ? `background-image:url('${img}'); background-size:cover; background-position:center;`
                        : 'background: linear-gradient(135deg, #fee2e2, #fecaca);';

                    const features = getRecipeFeaturesProfile(r);
                    const spiceText = spiceLabelProfile(r.spiciness);

                    let featuresHtml = '';
                    features.forEach(f => {
                        const label = FEATURE_LABELS[f] || f;
                        featuresHtml += `<span class="tag tag-feature">${label}</span>`;
                    });

                    let spiceHtml = '';
                    if (spiceText) {
                        spiceHtml = `<span class="tag tag-spice">${spiceText}</span>`;
                    }

                    const isSaved = savedRecipeIds.has(r.id);

                    card.innerHTML = `
                    <div class="recipe-img" style="${bgStyle}"></div>
                    <button class="card-heart-btn ${isSaved ? 'saved' : ''}">‚ô•</button>
                    <div class="card-content">
                        <div class="recipe-title">${r.title}</div>
                        <div class="recipe-meta">
                            <span>‚è± ${r.time_minutes || 0} —Ö–≤</span>
                            <span>${r.calories || 0} –∫–∫–∞–ª</span>
                        </div>
                        <div class="meta-tags-row">
                            ${featuresHtml}
                            ${spiceHtml}
                        </div>
                    </div>
                `;

                    const heartBtn = card.querySelector('.card-heart-btn');

                    heartBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        if (!currentUserId) {
                            alert("–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –∑–±–µ—Ä—ñ–≥–∞—Ç–∏!");
                            return;
                        }
                        if (isSavedList) {
                            await toggleSavedProfile(r.id, card, heartBtn);
                        } else {
                            await toggleSaveOnProfileList(r.id, heartBtn);
                        }
                    });

                    card.addEventListener('click', () => {
                        openProfileModal(r.id);
                    });

                    container.appendChild(card);
                    return;
                }

                // –í–∏–ø–∞–¥–æ–∫ 2: —Å–≤–æ—ó —Ä–µ—Ü–µ–ø—Ç–∏ ‚Üí —Å—Ç–∞—Ä—ñ –º—ñ–Ω—ñ-–∫–∞—Ä—Ç–∫–∏ –∑ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è–º
                let actionsHtml = '';
                if (isEditable) {
                    actionsHtml = `
                    <div class="rm-actions">
                        <a href="add-recipe.html?id=${r.id}" class="rm-btn">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
                        <button type="button" class="rm-btn rm-btn-delete" onclick="deleteRecipe('${r.id}')">
                            –í–∏–¥–∞–ª–∏—Ç–∏
                        </button>
                    </div>
                `;
                }

                const imgStyle = img
                    ? `background-image:url('${img}'); color:transparent;`
                    : '';

                const placeholderText = img ? '' : '–ë–µ–∑ —Ñ–æ—Ç–æ';

                const mini = document.createElement('div');
                mini.className = 'recipe-mini';
                mini.innerHTML = `
                <div class="rm-img" style="${imgStyle}">
                    ${placeholderText}
                </div>
                <div class="rm-body">
                    <div class="rm-title">${r.title}</div>
                    <div class="rm-meta">‚è± ${r.time_minutes || 0} —Ö–≤</div>
                    ${actionsHtml}
                </div>
            `;
                container.appendChild(mini);
            });
        }

        // 7. –¢–æ–≥–ª –∑–±–µ—Ä–µ–∂–µ–Ω–æ–≥–æ —É –≤–∫–ª–∞–¥—Ü—ñ "–ó–±–µ—Ä–µ–∂–µ–Ω—ñ" (–∑ –≤–∏–¥–∞–ª–µ–Ω–Ω—è–º –∫–∞—Ä—Ç–∫–∏)
        async function toggleSavedProfile(recipeId, cardEl, btnEl) {
            if (!currentUserId) return;
            const { error } = await supabase
                .from('saved_recipes')
                .delete()
                .match({ user_id: currentUserId, recipe_id: recipeId });

            if (error) {
                alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–µ: ' + error.message);
                return;
            }

            savedRecipeIds.delete(recipeId);
            if (btnEl) btnEl.classList.remove('saved');
            if (cardEl) cardEl.remove();

            const container = document.getElementById('savedRecipesGrid');
            if (container && container.children.length === 0) {
                container.innerHTML = '<p style="color:#9ca3af;">–ü–æ–∫–∏ —â–æ –ø—É—Å—Ç–æ.</p>';
            }
        }

        // 8. –¢–æ–≥–ª –∑–±–µ—Ä–µ–∂–µ–Ω–æ–≥–æ —É —Å–ø–∏—Å–∫—É —Ä–µ—Ü–µ–ø—Ç—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–ù–ï –≤–∏–¥–∞–ª—è—î–º–æ –∫–∞—Ä—Ç–∫—É)
        async function toggleSaveOnProfileList(recipeId, btnEl) {
            if (!currentUserId) return;
            const isSavedNow = savedRecipeIds.has(recipeId);

            if (isSavedNow) {
                const { error } = await supabase
                    .from('saved_recipes')
                    .delete()
                    .match({ user_id: currentUserId, recipe_id: recipeId });

                if (error) {
                    alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–µ: ' + error.message);
                    return;
                }
                savedRecipeIds.delete(recipeId);
                if (btnEl) btnEl.classList.remove('saved');
            } else {
                const { error } = await supabase
                    .from('saved_recipes')
                    .insert([{ user_id: currentUserId, recipe_id: recipeId }]);

                if (error) {
                    alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–µ: ' + error.message);
                    return;
                }
                savedRecipeIds.add(recipeId);
                if (btnEl) btnEl.classList.add('saved');
            }
        }

        // 9. –í–∏–¥–∞–ª–µ–Ω–Ω—è –≤–ª–∞—Å–Ω–æ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞
        async function deleteRecipe(id) {
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ä–µ—Ü–µ–ø—Ç –Ω–∞–∑–∞–≤–∂–¥–∏?')) return;
            const { error } = await supabase.from('recipes').delete().eq('id', id);
            if (error) {
                alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ —Ä–µ—Ü–µ–ø—Ç: ' + error.message);
                return;
            }
            if (currentUserId) {
                loadUserRecipes(currentUserId);
            }
        }

        // 10. –†—ñ–≤–µ–Ω—å
        function getLevelIndex(totalXp) {
            let idx = Math.floor(totalXp / LEVEL_RANGE);
            if (idx < 0) idx = 0;
            if (idx >= LEVEL_NAMES.length) idx = LEVEL_NAMES.length - 1;
            return idx;
        }

        function updateLevel(totalXp) {
            const levelIndex = getLevelIndex(totalXp);
            const levelName = LEVEL_NAMES[levelIndex];

            const xpInLevel = totalXp % LEVEL_RANGE;
            const xpToNext = LEVEL_RANGE - xpInLevel;
            const percent = (xpInLevel / LEVEL_RANGE) * 100;

            document.getElementById('levelName').textContent = levelName;
            document.getElementById('levelXP').textContent = `${xpInLevel} / ${LEVEL_RANGE} XP`;
            document.getElementById('levelFill').style.width = `${Math.min(100, percent)}%`;

            const xpTextEl = document.getElementById('xpText');
            if (levelIndex === LEVEL_NAMES.length - 1) {
                xpTextEl.textContent = `–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ä—ñ–≤–µ–Ω—å! –ü—Ä–æ–¥–æ–≤–∂—É–π—Ç–µ –Ω–∞–±–∏—Ä–∞—Ç–∏ XP üòé`;
            } else {
                xpTextEl.textContent = `–©–µ ${xpToNext} XP –¥–æ –Ω–æ–≤–æ–≥–æ —Ä—ñ–≤–Ω—è.`;
            }
        }

        async function addXp(amount) {
            if (!currentUserId || amount <= 0) return;

            const { data: profile, error } = await supabase
                .from('profiles')
                .select('xp')
                .eq('id', currentUserId)
                .single();

            if (error) {
                console.error('XP load error', error);
                return;
            }

            const oldXp = profile?.xp || 0;
            const oldLevelIndex = getLevelIndex(oldXp);

            const newXp = oldXp + amount;
            const newLevelIndex = getLevelIndex(newXp);

            const { error: updateError } = await supabase
                .from('profiles')
                .update({
                    xp: newXp,
                    updated_at: new Date()
                })
                .eq('id', currentUserId);

            if (updateError) {
                console.error('XP update error', updateError);
                return;
            }

            updateLevel(newXp);

            if (newLevelIndex > oldLevelIndex) {
                const newLevelName = LEVEL_NAMES[newLevelIndex];
                alert(`–í—ñ—Ç–∞—î–º–æ! –í–∏ –¥–æ—Å—è–≥–ª–∏ —Ä—ñ–≤–Ω—è "${newLevelName}" üéâ`);
            }
        }

        // 11. –ú–æ–¥–∞–ª–∫–∞ —Ä–µ—Ü–µ–ø—Ç–∞
        function openProfileModal(recipeId) {
            const r = profileRecipesMap.get(recipeId);
            if (!r) return;

            currentRecipeId = r.id;

            document.getElementById('mTitle').textContent = r.title || '';
            document.getElementById('mTime').textContent = `‚è± ${r.time_minutes || 0} —Ö–≤`;
            document.getElementById('mCal').textContent = `${r.calories || 0} –∫–∫–∞–ª`;
             const macrosEl = document.getElementById('mMacros');
            if (macrosEl) {
                const p = r.protein ?? 0;
                const f = r.fat ?? 0;
                const c = r.carbs ?? 0;
                macrosEl.textContent = `–±—ñ–ª–∫–∏: ${p}–≥ | –∂–∏—Ä–∏: ${f}–≥ | –≤—É–≥–ª–µ–≤–æ–¥–∏: ${c}–≥`;
            }

            const gallery = document.getElementById('mGallery');
            gallery.innerHTML = '';
            let photos = Array.isArray(r.image_url) ? r.image_url : (r.image_url ? [r.image_url] : []);
            if (photos.length === 0) {
                const empty = document.createElement('div');
                empty.style.width = '100%';
                empty.style.height = '100%';
                gallery.appendChild(empty);
            } else {
                photos.forEach(url => {
                    const img = document.createElement('img');
                    img.src = url;
                    gallery.appendChild(img);
                });
            }

            document.getElementById('btnPrev').style.display = photos.length > 1 ? 'flex' : 'none';
            document.getElementById('btnNext').style.display = photos.length > 1 ? 'flex' : 'none';

            // –ê–≤—Ç–æ—Ä ‚Äì —Ç—É—Ç –º–æ–∂–Ω–∞ –∑–∞—Ö–æ–≤–∞—Ç–∏ –∞–±–æ –¥–æ–æ–ø—Ä–∞—Ü—é–≤–∞—Ç–∏ (–∑–∞—Ä–∞–∑ —Ö–æ–≤–∞—é)
            const authBlock = document.getElementById('mAuthor');
            if (authBlock) authBlock.style.display = 'none';

            const ul = document.getElementById('mIng');
            ul.innerHTML = '';
            if (Array.isArray(r.ingredients)) {
                r.ingredients.forEach(ing => {
                    const li = document.createElement('li');
                    li.style.marginBottom = '8px';
                    li.innerHTML = `<b>${ing.name || ''}</b>: ${ing.amount || ''}`;
                    ul.appendChild(li);
                });
            }

            const ol = document.getElementById('mSteps');
            ol.innerHTML = '';
            if (Array.isArray(r.steps)) {
                r.steps.forEach(s => {
                    const li = document.createElement('li');
                    li.textContent = s;
                    li.style.marginBottom = '10px';
                    ol.appendChild(li);
                });
            }

            const mMetaTags = document.getElementById('mMetaTags');
            mMetaTags.innerHTML = '';
            const features = getRecipeFeaturesProfile(r);
            features.forEach(f => {
                const label = FEATURE_LABELS[f] || f;
                mMetaTags.innerHTML += `<span class="tag tag-feature">${label}</span>`;
            });
            const sText = spiceLabelProfile(r.spiciness);
            if (sText) {
                mMetaTags.innerHTML += `<span class="tag tag-spice">${sText}</span>`;
            }

            checkIfSavedInModalProfile();
            resetStarsUI();
            loadReviewsProfile();

            document.getElementById('recipeModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('recipeModal').classList.remove('show');
        }

        function scrollGallery(dir) {
            const g = document.getElementById('mGallery');
            g.scrollBy({ left: g.clientWidth * dir, behavior: 'smooth' });
        }

        function resetStarsUI() {
            currentRating = 0;
            document.querySelectorAll('#starRating span').forEach(s => s.classList.remove('active'));
        }

        const btnSaveModal = document.getElementById('btnSaveModal');
        btnSaveModal.onclick = async () => {
            if (!currentUserId) {
                alert("–£–≤—ñ–π–¥—ñ—Ç—å!");
                return;
            }
            if (!currentRecipeId) return;

            if (btnSaveModal.classList.contains('saved')) {
                const { error } = await supabase
                    .from('saved_recipes')
                    .delete()
                    .match({ user_id: currentUserId, recipe_id: currentRecipeId });

                if (error) {
                    alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–µ: " + error.message);
                    return;
                }
                btnSaveModal.classList.remove('saved');
                savedRecipeIds.delete(currentRecipeId);
            } else {
                const { error } = await supabase
                    .from('saved_recipes')
                    .insert([{ user_id: currentUserId, recipe_id: currentRecipeId }]);

                if (error) {
                    alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–µ: " + error.message);
                    return;
                }
                btnSaveModal.classList.add('saved');
                savedRecipeIds.add(currentRecipeId);
            }

            // –û–Ω–æ–≤–ª—é—î–º–æ —Å–µ—Ä—Ü–µ –Ω–∞ –∫–∞—Ä—Ç—Ü—ñ
            const cardHeart = document.querySelector(`.recipe-card[data-id="${currentRecipeId}"] .card-heart-btn`);
            if (cardHeart) {
                if (savedRecipeIds.has(currentRecipeId)) {
                    cardHeart.classList.add('saved');
                } else {
                    cardHeart.classList.remove('saved');
                }
            }

            // –Ø–∫—â–æ —Ü–µ –≤–∫–ª–∞–¥–∫–∞ "–ó–±–µ—Ä–µ–∂–µ–Ω—ñ" —ñ –º–∏ —Ä–æ–∑–∑–±–µ—Ä–µ–≥–ª–∏ ‚Äì –ø—Ä–∏–±–µ—Ä–µ–º–æ –∫–∞—Ä—Ç–∫—É
            const savedGrid = document.getElementById('savedRecipesGrid');
            if (savedGrid && cardHeart && savedGrid.contains(cardHeart)) {
                const card = cardHeart.closest('.recipe-card');
                if (card && !savedRecipeIds.has(currentRecipeId)) {
                    card.remove();
                    if (savedGrid.children.length === 0) {
                        savedGrid.innerHTML = '<p style="color:#9ca3af;">–ü–æ–∫–∏ —â–æ –ø—É—Å—Ç–æ.</p>';
                    }
                }
            }
        };

        function checkIfSavedInModalProfile() {
            btnSaveModal.classList.toggle('saved', savedRecipeIds.has(currentRecipeId));
        }

        // –í—ñ–¥–≥—É–∫–∏
        async function sendReview() {
            if (!currentUser) return alert("–£–≤—ñ–π–¥—ñ—Ç—å!");
            const text = document.getElementById('reviewText').value;
            if (!currentRating) return alert("–û–±–µ—Ä—ñ—Ç—å –æ—Ü—ñ–Ω–∫—É!");
            const { error } = await supabase.from('reviews').insert([{
                recipe_id: currentRecipeId,
                user_id: currentUser.id,
                rating: currentRating,
                comment: text
            }]);
            if (!error) {
                document.getElementById('reviewText').value = "";
                resetStarsUI();
                loadReviewsProfile();
            }
        }

        async function loadReviewsProfile() {
            const list = document.getElementById('reviewsList');
            list.innerHTML = '...';
            const { data: reviews } = await supabase.from('reviews')
                .select('*, profiles(full_name)')
                .eq('recipe_id', currentRecipeId)
                .order('created_at', { ascending: false });

            list.innerHTML = '';
            if (!reviews || !reviews.length) {
                list.innerHTML = '<p style="color:#888; font-size:0.9rem;">–ù–µ–º–∞—î –≤—ñ–¥–≥—É–∫—ñ–≤.</p>';
                return;
            }
            reviews.forEach(rev => {
                const div = document.createElement('div');
                div.className = 'review-item';
                const stars = '‚òÖ'.repeat(rev.rating);
                const name = rev.profiles ? rev.profiles.full_name : '–ì—ñ—Å—Ç—å';
                const canDelete = currentUser && currentUser.id === rev.user_id;

                div.innerHTML = `
                <div class="review-author">
                    <span>${name}</span>
                    <span>
                        <span style="color:#fbbf24;">${stars}</span>
                        ${canDelete ? `
                            <button class="reset-link" style="margin-left:8px;" onclick="deleteReviewProfile('${rev.id}')">
                                –í–∏–¥–∞–ª–∏—Ç–∏
                            </button>
                        ` : ''}
                    </span>
                </div>
                <div class="review-text">${rev.comment || ''}</div>
            `;
                list.appendChild(div);
            });
        }

        async function deleteReviewProfile(reviewId) {
            if (!currentUser) {
                alert("–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –≤–∏–¥–∞–ª—è—Ç–∏ –≤—ñ–¥–≥—É–∫–∏!");
                return;
            }
            const { error } = await supabase
                .from('reviews')
                .delete()
                .match({
                    id: reviewId,
                    user_id: currentUser.id
                });

            if (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –≤—ñ–¥–≥—É–∫—É:', error.message);
                alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—ñ–¥–≥—É–∫. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.");
                return;
            }
            loadReviewsProfile();
        }

        function openTab(tabId, btn) {
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        async function logout() {
            await supabase.auth.signOut();
            window.location.href = "index.html";
        }

        // –°—Ç–∞—Ä—Ç
        document.addEventListener('DOMContentLoaded', () => {
            loadProfile();
        });
    </script>

</body>

</html>