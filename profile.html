<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <title>–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å ‚Äì FoodMatch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- –®—Ä–∏—Ñ—Ç —è–∫ –Ω–∞ —ñ–Ω—à–∏—Ö  -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #A10404;
            --primary-hover: #7c0303;
            --bg-body: #f3f4f6;
            --surface: #ffffff;
            --text-main: #111827;
            --text-light: #6B7280;
            --border: #E5E7EB;
            --radius: 20px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: url('img/background.jpg') center/cover no-repeat fixed;
            color: var(--text-main);
            line-height: 1.5;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        input,
        textarea,
        select {
            font-family: inherit;
        }

        button {
            font-family: inherit;
            cursor: pointer;
        }

        /* HEADER ‚Äì —è–∫ –Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π */
        header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e5e7eb;
            height: 70px;
            display: flex;
            align-items: center;
        }

        .nav {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            font-weight: 800;
            font-size: 1.4rem;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .nav-links-center {
            display: flex;
            gap: 20px;
        }

        .nav-links-center a {
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #111827;
        }

        .nav-links-center a:hover {
            color: var(--primary);
        }

        .nav-links-center a.active {
            color: var(--primary);
        }

        .nav-btn {
            border-radius: 999px;
            background: var(--primary);
            border: 1px solid var(--primary);
            color: #fff;
            padding: 8px 18px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            transition: 0.2s;
        }

        .nav-btn:hover {
            transform: translateY(-1px);
            background: var(--primary-hover);
            border-color: var(--primary-hover);
            box-shadow: 0 4px 12px rgba(161, 4, 4, 0.35);
        }

        button:focus,
        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 1px rgba(161, 4, 4, 0.12);
        }

        /* LAYOUT */
        .container {
            max-width: 1100px;
            margin: 30px auto 60px;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 30px;
            align-items: start;
        }

        @media (max-width: 850px) {
            .container {
                grid-template-columns: 1fr;
            }

            .nav-links-center {
                display: none;
            }
        }

        /* SIDEBAR */
        .profile-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 30px 20px;
            text-align: center;
            border: 1px solid var(--border);
            position: sticky;
            top: 100px;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.06);
        }

        .avatar-box {
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
            border-radius: 50%;
            background: #FFF7ED;
            border: 4px solid #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            line-height: 1;
            color: #4B5563;
            font-weight: 700;
        }

        .avatar-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-name {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 2px;
        }

        .user-nick {
            font-size: 0.95rem;
            color: var(--text-light);
            margin-bottom: 15px;
            font-weight: 500;
        }

        .user-bio {
            font-size: 0.9rem;
            color: #4B5563;
            margin-bottom: 20px;
            font-style: italic;
            background: #F9FAFB;
            padding: 10px;
            border-radius: 10px;
            word-wrap: break-word;
        }

        .sidebar-socials {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 25px;
        }

        .social-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #F3F4F6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1F2937;
            transition: 0.2s;
        }

        .social-icon:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .social-icon.hidden {
            display: none;
        }

        .level-box {
            text-align: left;
            padding: 15px;
            background: #FFF7ED;
            border-radius: 12px;
            border: 1px solid #FFEDD5;
            margin-bottom: 20px;
        }

        .level-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: #9A3412;
        }

        .progress-bar {
            height: 8px;
            background: #FED7AA;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 1s ease;
        }

        .profile-menu {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 5px;
        }

        .menu-btn {
            background: none;
            border: none;
            padding: 12px 16px;
            border-radius: 10px;
            text-align: left;
            cursor: pointer;
            font-size: 0.95rem;
            color: #4B5563;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.1s;
        }

        .menu-btn:hover {
            background: #F3F4F6;
            color: #111827;
        }

        .menu-btn.active {
            background: #111827;
            color: white;
        }

        .menu-btn.logout {
            color: #EF4444;
            margin-top: 10px;
            border-top: 1px solid #F3F4F6;
            border-radius: 0;
        }

        .menu-btn.logout:hover {
            background: #FEF2F2;
        }

        /* MAIN CONTENT */
        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        .settings-box {
            background: var(--surface);
            padding: 32px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.05);
        }

        .section-title-main {
            font-size: 1rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: #111827;
            margin-bottom: 18px;
        }

        .form-section-title {
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #9CA3AF;
            margin-bottom: 15px;
            margin-top: 25px;
        }

        .form-section-title:first-child {
            margin-top: 0;
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }

        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: 0.2s;
            background: #FFF7ED;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            user-select: none;
        }

        .avatar-option:hover {
            transform: scale(1.1);
            background: #FFEDD5;
        }

        .avatar-option.selected {
            border-color: var(--primary);
            background: #FFF7ED;
            box-shadow: 0 0 0 3px rgba(161, 4, 4, 0.2);
            transform: scale(1.05);
        }

        .upload-btn-grid {
            border: 2px dashed #D1D5DB;
            background: #ffffff;
            color: #9CA3AF;
            font-size: 1.5rem;
        }

        .upload-btn-grid:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .input-wrapper {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 14px;
            top: 12px;
            color: #9CA3AF;
            font-size: 1.1rem;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
            font-size: 1rem;
            outline: none;
            background: #FFFFFF;
            transition: 0.2s;
        }

        .with-icon {
            padding-left: 44px;
        }

        input:focus,
        textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(161, 4, 4, 0.1);
        }

        .social-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 850px) {
            .profile-card {
                position: static;
                margin-bottom: 20px;
            }

            .social-grid {
                grid-template-columns: 1fr;
            }
        }

        .btn-main {
            background: #111827;
            color: #fff;
            padding: 12px 40px;
            border-radius: 999px;
            border: none;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-main:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        /* üî¥ –ë–æ—Ä–¥–æ–≤–∞ –∫–Ω–æ–ø–∫–∞ "–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏" */
        .btn-save {
            background: var(--primary);
            color: #fff;
            padding: 12px 40px;
            border-radius: 999px;
            border: none;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 4px 15px rgba(161, 4, 4, 0.35);
        }

        .btn-save:hover {
            transform: translateY(-1px);
            background: var(--primary-hover);
            box-shadow: 0 8px 22px rgba(161, 4, 4, 0.45);
        }

        /* RECIPES LIST */
        .recipes-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }

        .recipe-mini {
            background: white;
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }

        .recipe-mini:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.06);
        }

        .rm-img {
            height: 140px;
            background: #FFEDD5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            background-size: cover;
            background-position: center;
            color: #4B5563;
        }

        .rm-body {
            padding: 14px;
        }

        .rm-title {
            font-weight: 700;
            margin-bottom: 4px;
            font-size: 1rem;
        }

        .rm-meta {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .rm-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .rm-btn {
            flex: 1;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            padding: 8px;
            text-align: center;
            background: #F3F4F6;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #374151;
            border: none;
        }

        .rm-btn:hover {
            background: #E5E7EB;
        }

        .rm-btn-delete {
            background: #FEF2F2;
            color: #B91C1C;
        }

        .rm-btn-delete:hover {
            background: #FEE2E2;
        }

        /* —Å–µ—Ä–¥–µ—á–∫–æ –Ω–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö */
        .mini-heart-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #E5E7EB;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #D1D5DB;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s;
            z-index: 5;
        }

        .mini-heart-btn:hover {
            transform: scale(1.05);
            background: #ffffff;
        }

        .mini-heart-btn.saved {
            color: var(--primary);
            border-color: var(--primary);
            background: #FEF2F2;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

<header>
    <nav class="nav">
        <a href="index.html" class="logo">
            <img src="img/logo.jpg" alt="FoodMatch logo" class="logo-icon">
            <div>FoodMatch</div>
        </a>
        <div class="nav-links-center">
            <a href="add-recipe.html">–î–æ–¥–∞—Ç–∏ —Ä–µ—Ü–µ–ø—Ç</a>
            <a href="shopping-list.html">–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</a>
        </div>
        <div class="nav-actions">
            <!-- –¥–æ–¥–∞–ª–∏ id="topNavBtn" -->
            <a href="index.html" class="nav-btn" id="topNavBtn">–ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
        </div>
    </nav>
</header>

    <div class="container">

        <aside>
            <div class="profile-card">
                <div class="avatar-box" id="sidebarAvatar">FM</div>

                <div class="user-name" id="sidebarName">...</div>
                <div class="user-nick" id="sidebarNick">@...</div>
                <div class="user-bio" id="sidebarBio"></div>

                <div class="sidebar-socials">
                    <a href="#" target="_blank" class="social-icon hidden" id="linkInsta" title="Instagram">
                        <span style="font-size:0.85rem; font-weight:600;">IG</span>
                    </a>
                    <a href="#" target="_blank" class="social-icon hidden" id="linkTiktok" title="TikTok">
                        <span style="font-size:0.85rem; font-weight:600;">TT</span>
                    </a>
                    <a href="#" target="_blank" class="social-icon hidden" id="linkTelegram" title="Telegram">
                        <span style="font-size:0.85rem; font-weight:600;">TG</span>
                    </a>
                </div>

                <div class="level-box">
                    <div class="level-header">
                        <span id="levelName">–ù–æ–≤–∞—á–æ–∫</span>
                        <span id="levelXP">0 / 1000 XP</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="levelFill"></div>
                    </div>
                    <div id="xpText" style="font-size:0.75rem; color:#9ca3af; margin-top:5px; text-align:center;"></div>
                </div>

                <div class="profile-menu">
                    <button id="btnSettings" class="menu-btn active" onclick="openTab('settings', this)">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
                    <button id="btnMyRecipes" class="menu-btn" onclick="openTab('my-recipes', this)">–ú–æ—ó —Ä–µ—Ü–µ–ø—Ç–∏</button>
                    <button id="btnSaved" class="menu-btn" onclick="openTab('saved', this)">–ó–±–µ—Ä–µ–∂–µ–Ω—ñ</button>
                    <button class="menu-btn logout" onclick="logout()">–í–∏–π—Ç–∏</button>
                </div>
            </div>
        </aside>

        <main>

            <div id="settings" class="content-section active">
                <h1 class="section-title-main">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</h1>

                <div class="settings-box">
                    <form onsubmit="saveProfile(event)">

                        <div class="form-section-title">–û–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∞–±–æ —Ñ–æ—Ç–æ</div>

                        <div class="avatar-grid" id="avatarSelector">
                            <div class="avatar-option upload-btn-grid"
                                onclick="document.getElementById('fileInput').click()" title="–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–≤–æ—î —Ñ–æ—Ç–æ">
                                üì∑
                            </div>
                        </div>
                        <input type="file" id="fileInput" hidden accept="image/*" onchange="uploadCustomAvatar(this)">
                        <input type="hidden" id="inputAvatarUrl">

                        <div class="form-section-title">–û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</div>

                        <div class="social-grid">
                            <div class="form-group">
                                <label>–í–∞—à–µ —ñ–º'—è</label>
                                <input type="text" id="inputName" placeholder="–û–ª–µ–∫—Å—ñ–π" required>
                            </div>
                            <div class="form-group">
                                <label>–ù—ñ–∫–Ω–µ–π–º (–±–µ–∑ @)</label>
                                <div class="input-wrapper">
                                    <span class="input-icon">@</span>
                                    <input type="text" id="inputNick" class="with-icon" placeholder="alex_cook">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>–ü—Ä–æ —Å–µ–±–µ</label>
                            <textarea id="inputBio" rows="3"
                                placeholder="–†–æ–∑–∫–∞–∂—ñ—Ç—å –ø—Ä–æ —Å–≤–æ—ó –∫—É–ª—ñ–Ω–∞—Ä–Ω—ñ –≤–ø–æ–¥–æ–±–∞–Ω–Ω—è..."></textarea>
                        </div>

                        <div class="form-section-title">–°–æ—Ü—ñ–∞–ª—å–Ω—ñ –º–µ—Ä–µ–∂—ñ</div>

                        <div class="social-grid">
                            <div class="form-group">
                                <label>Instagram</label>
                                <div class="input-wrapper">
                                    <input type="text" id="inputInsta" placeholder="https://instagram.com/...">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>TikTok</label>
                                <div class="input-wrapper">
                                    <input type="text" id="inputTiktok" placeholder="https://tiktok.com/...">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Telegram</label>
                                <div class="input-wrapper">
                                    <input type="text" id="inputTelegram" placeholder="https://t.me/...">
                                </div>
                            </div>
                        </div>

                        <div style="text-align: right; margin-top: 20px;">
                            <button type="submit" class="btn-save">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="my-recipes" class="content-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:18px;">
                    <h1 id="myRecipesTitle" class="section-title-main" style="margin-bottom:0;">–ú–æ—ó —Ä–µ—Ü–µ–ø—Ç–∏</h1>
                    <a id="btnCreateRecipe" href="add-recipe.html" class="btn-main" style="padding:10px 22px; font-size:0.8rem;">
                        –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ä–µ—Ü–µ–ø—Ç
                    </a>
         
                </div>
                <div class="settings-box" style="padding:20px;">
                    <div class="recipes-list" id="myRecipesGrid">
                        <p style="color:#6b7280;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
                    </div>
                </div>
            </div>

            <div id="saved" class="content-section">
                <h1 class="section-title-main">–ó–±–µ—Ä–µ–∂–µ–Ω—ñ</h1>
                <div class="settings-box" style="padding:20px;">
                    <div class="recipes-list" id="savedRecipesGrid">
                        <p style="color:#6b7280;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/db.js"></script>

    <script>
        // 1. –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
        const EMOJI_AVATARS = ['üë®‚Äçüç≥', 'üë©‚Äçüç≥', 'üçî', 'üçï', 'ü•ó', 'ü•ë', 'ü•¶', 'üçì', 'üç©', 'ü•ê', '‚òï', 'üç±'];
        let currentUserId = null;
        let viewedUserId = null;   // —á–∏–π –ø—Ä–æ—Ñ—ñ–ª—å –ø–æ–∫–∞–∑—É—î–º–æ
        let isOwnProfile = true;   // —á–∏ —Ü–µ –Ω–∞—à –ø—Ä–æ—Ñ—ñ–ª—å, —á–∏ —á—É–∂–∏–π
        

        // üî• –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏ —Å–∏—Å—Ç–µ–º–∏ —Ä—ñ–≤–Ω—ñ–≤
        const LEVEL_RANGE = 1000; // 0‚Äì1000 XP –Ω–∞ —Ä—ñ–≤–µ–Ω—å
        const LEVEL_NAMES = [
            "–ù–æ–≤–∞—á–æ–∫",   // —Ä—ñ–≤–µ–Ω—å 0
            "–õ—é–±–∏—Ç–µ–ª—å",  // —Ä—ñ–≤–µ–Ω—å 1
            "–°—É-—à–µ—Ñ",    // —Ä—ñ–≤–µ–Ω—å 2
            "–®–µ—Ñ",       // —Ä—ñ–≤–µ–Ω—å 3
            "–õ–µ–≥–µ–Ω–¥–∞"    // —Ä—ñ–≤–µ–Ω—å 4+
        ];

        document.addEventListener('DOMContentLoaded', loadProfile);

        function initAvatarSelector(currentUrl) {
            const container = document.getElementById('avatarSelector');
            while (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }
            EMOJI_AVATARS.forEach(emoji => {
                const div = document.createElement('div');
                div.className = 'avatar-option';
                div.textContent = emoji;
                if (currentUrl === emoji) div.classList.add('selected');
                div.onclick = () => {
                    selectAvatar(emoji);
                    document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
                    document.querySelector('.upload-btn-grid').classList.remove('selected');
                    div.classList.add('selected');
                };
                container.appendChild(div);
            });
        }

        function selectAvatar(value) {
            document.getElementById('inputAvatarUrl').value = value;
            const sidebarAvatar = document.getElementById('sidebarAvatar');
            if (value.startsWith('http')) {
                sidebarAvatar.innerHTML = `<img src="${value}" style="width:100%; height:100%; object-fit:cover;">`;
            } else {
                sidebarAvatar.innerHTML = value;
            }
        }

        // 2. –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –î–ê–ù–ò–•
            async function loadProfile() {
                // 1) id –∑ URL, —è–∫—â–æ –ø—Ä–∏–π—à–ª–∏ –∑ —Ä–µ—Ü–µ–ø—Ç–∞: profile.html?id=...
                const params = new URLSearchParams(window.location.search);
                const foreignId = params.get('id');

                // 2) –ø–æ—Ç–æ—á–Ω–∏–π –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏–π —é–∑–µ—Ä
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    window.location.href = "login.html";
                    return;
                }

                currentUserId = user.id;

                // 3) –≤–∏—Ä—ñ—à—É—î–º–æ, —Å–≤—ñ–π —á–∏ —á—É–∂–∏–π –ø—Ä–æ—Ñ—ñ–ª—å
                if (foreignId && foreignId !== user.id) {
                    viewedUserId = foreignId;
                    isOwnProfile = false;
                } else {
                    viewedUserId = user.id;
                    isOwnProfile = true;
                }

                // 3.1. –û–Ω–æ–≤–ª—é—î–º–æ –∫–Ω–æ–ø–∫—É –≤ —Ö–µ–¥–µ—Ä—ñ
                const topNavBtn = document.getElementById('topNavBtn');
                if (topNavBtn) {
                    if (isOwnProfile) {
                        topNavBtn.textContent = '–ù–∞ –≥–æ–ª–æ–≤–Ω—É';
                        topNavBtn.href = 'index.html';
                    } else {
                        topNavBtn.textContent = '–ø—Ä–æ—Ñ—ñ–ª—å';
                        topNavBtn.href = 'profile.html'; // –±–µ–∑ id ‚Üí —Å–≤—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å
                    }
                }

                // 4) —Ç—è–≥–Ω–µ–º–æ –ø—Ä–æ—Ñ—ñ–ª—å —Ç–æ–≥–æ, –∫–æ–≥–æ –¥–∏–≤–∏–º–æ—Å—å
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', viewedUserId)
                    .single();

                if (!profile) {
                    document.getElementById('sidebarName').textContent = "–ü—Ä–æ—Ñ—ñ–ª—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ";
                    return;
                }

                // 5) —Å–∞–π–¥–±–∞—Ä
                document.getElementById('sidebarName').textContent = profile.full_name || "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á";
                document.getElementById('sidebarNick').textContent = profile.username ? `@${profile.username}` : "@...";
                document.getElementById('sidebarBio').textContent = profile.about || "–ù–∞–ø–∏—à—ñ—Ç—å –ø—Ä–æ —Å–µ–±–µ...";

                const avatar = profile.avatar_url || 'FM';
                selectAvatar(avatar);

                updateSocial('linkInsta', profile.instagram);
                updateSocial('linkTiktok', profile.tiktok);
                updateSocial('linkTelegram', profile.telegram);

                // 6) —è–∫—â–æ —Ü–µ –ú–Ü–ô –ø—Ä–æ—Ñ—ñ–ª—å ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
                if (isOwnProfile) {
                    document.getElementById('inputName').value = profile.full_name || "";
                    document.getElementById('inputNick').value = profile.username || "";
                    document.getElementById('inputBio').value = profile.about || "";
                    document.getElementById('inputInsta').value = profile.instagram || "";
                    document.getElementById('inputTiktok').value = profile.tiktok || "";
                    document.getElementById('inputTelegram').value = profile.telegram || "";
                    document.getElementById('inputAvatarUrl').value = avatar;

                    initAvatarSelector(avatar);
                } else {
                    // —è–∫—â–æ –ß–£–ñ–ò–ô –ø—Ä–æ—Ñ—ñ–ª—å ‚Äî —Ö–æ–≤–∞—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è, –∑–±–µ—Ä–µ–∂–µ–Ω—ñ —ñ –∫–Ω–æ–ø–∫—É "–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ä–µ—Ü–µ–ø—Ç"
                    const btnSettings = document.getElementById('btnSettings');
                    const btnSaved = document.getElementById('btnSaved');
                    const tabSettings = document.getElementById('settings');
                    const tabSaved = document.getElementById('saved');
                    const btnCreate = document.getElementById('btnCreateRecipe');
                    const title = document.getElementById('myRecipesTitle');

                    if (btnSettings) btnSettings.style.display = 'none';
                    if (tabSettings) tabSettings.style.display = 'none';

                    if (btnSaved) btnSaved.style.display = 'none';
                    if (tabSaved) tabSaved.style.display = 'none';

                    if (btnCreate) btnCreate.style.display = 'none';
                    if (title) title.textContent = '–†–µ—Ü–µ–ø—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞';

                    // –∞–∫—Ç–∏–≤—É—î–º–æ –æ–¥—Ä–∞–∑—É –≤–∫–ª–∞–¥–∫—É –∑ —Ä–µ—Ü–µ–ø—Ç–∞–º–∏
                    document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                    document.getElementById('btnMyRecipes').classList.add('active');
                    document.getElementById('my-recipes').classList.add('active');
                }

                // 7) —Ä—ñ–≤–µ–Ω—å –ø–æ XP
                updateLevel(profile.xp || 0);

                // 8) —Ä–µ—Ü–µ–ø—Ç–∏ —Ç–æ–≥–æ, –∫–æ–≥–æ –¥–∏–≤–∏–º–æ—Å—å
                loadUserRecipes(viewedUserId);

                // 9) –∑–±–µ—Ä–µ–∂–µ–Ω—ñ ‚Äî —Ç—ñ–ª—å–∫–∏ –¥–ª—è —Å–≤–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é
                if (isOwnProfile) {
                    loadSavedRecipes(currentUserId);
                } else {
                    const savedContainer = document.getElementById('savedRecipesGrid');
                    if (savedContainer) {
                        savedContainer.innerHTML =
                            '<p style="color:#9ca3af;">–ó–±–µ—Ä–µ–∂–µ–Ω—ñ —Ä–µ—Ü–µ–ø—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ –¥–ª—è —á—É–∂–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é.</p>';
                    }
                }
            }

     

        function updateSocial(id, url) {
            const el = document.getElementById(id);
            if (url && url.length > 5) {
                el.href = url;
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }

        // 3. –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –§–û–¢–û
        async function uploadCustomAvatar(input) {
            const file = input.files[0];
            if (!file) return;
            document.body.style.cursor = 'wait';

            const { data: { user } } = await supabase.auth.getUser();
            const fileExt = file.name.split('.').pop();
            const fileName = `${user.id}-${Date.now()}.${fileExt}`;

            const { error } = await supabase.storage.from('AVATARS').upload(fileName, file);

            if (!error) {
                const { data } = supabase.storage.from('AVATARS').getPublicUrl(fileName);
                selectAvatar(data.publicUrl);
                document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
                document.querySelector('.upload-btn-grid').classList.add('selected');
            } else {
                alert("–ü–æ–º–∏–ª–∫–∞: " + error.message);
            }
            document.body.style.cursor = 'default';
        }

        // 4. –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø –ü–†–û–§–Ü–õ–Æ
        async function saveProfile(e) {
            e.preventDefault();
            const { data: { user } } = await supabase.auth.getUser();

            const updates = {
                id: user.id,
                full_name: document.getElementById('inputName').value,
                username: document.getElementById('inputNick').value || null,
                about: document.getElementById('inputBio').value || null,
                instagram: document.getElementById('inputInsta').value || null,
                tiktok: document.getElementById('inputTiktok').value || null,
                telegram: document.getElementById('inputTelegram').value || null,
                avatar_url: document.getElementById('inputAvatarUrl').value,
                updated_at: new Date()
            };

            const { error } = await supabase.from('profiles').upsert(updates);
            if (!error) {
                alert("–ó–º—ñ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ.");
                loadProfile();
            } else {
                alert(error.message);
            }
        }

        // 5. –°–ü–ò–°–ö–ò –†–ï–¶–ï–ü–¢–Ü–í
       async function loadUserRecipes(uid) {
    const { data: recipes } = await supabase
        .from('recipes')
        .select('*')
        .eq('author_id', uid)
        .order('created_at', { ascending: false });

    const container = document.getElementById('myRecipesGrid');

    // isEditable = —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ü–µ –Ω–∞—à –≤–ª–∞—Å–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å
    renderRecipeList(recipes, container, isOwnProfile, false);
}


        async function loadSavedRecipes(uid) {
            const { data: saved } = await supabase
                .from('saved_recipes')
                .select('recipe_id, recipes(*)')
                .eq('user_id', uid);

            const container = document.getElementById('savedRecipesGrid');
            if (saved && saved.length > 0) {
                const recipes = saved.map(item => item.recipes);
                renderRecipeList(recipes, container, false, true);
            } else {
                container.innerHTML = '<p style="color:#9ca3af;">–ü–æ–∫–∏ —â–æ –ø—É—Å—Ç–æ.</p>';
            }
        }

        // isEditable = "–º–æ—ó —Ä–µ—Ü–µ–ø—Ç–∏" (—Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ + –≤–∏–¥–∞–ª–∏—Ç–∏)
        // isSavedList = "–∑–±–µ—Ä–µ–∂–µ–Ω—ñ" (—Å–µ—Ä–¥–µ—á–∫–æ –∑–≤–µ—Ä—Ö—É)
        function renderRecipeList(recipes, container, isEditable, isSavedList = false) {
            container.innerHTML = '';
            if (!recipes || !recipes.length) {
                container.innerHTML = '<p style="color:#9ca3af;">–ü–æ–∫–∏ —â–æ –ø—É—Å—Ç–æ.</p>';
                return;
            }
            recipes.forEach(r => {
                let img = '';
                let placeholderText = '–ë–µ–∑ —Ñ–æ—Ç–æ';
                if (r.image_url) {
                    if (Array.isArray(r.image_url) && r.image_url.length > 0) img = `url('${r.image_url[0]}')`;
                    else if (typeof r.image_url === 'string') img = `url('${r.image_url}')`;
                }

                let actionsHtml = '';
                if (isEditable) {
                    actionsHtml = `
                    <div class="rm-actions">
                        <a href="add-recipe.html?id=${r.id}" class="rm-btn">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
                        <button type="button" class="rm-btn rm-btn-delete" onclick="deleteRecipe('${r.id}')">
                            –í–∏–¥–∞–ª–∏—Ç–∏
                        </button>
                    </div>
                `;
                } else if (isSavedList) {
                    actionsHtml = `
                    <div class="rm-actions">
                        <a href="index.html" class="rm-btn">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</a>
                    </div>
                `;
                }

                const heartHtml = isSavedList
                    ? `<button class="mini-heart-btn saved" onclick="toggleSavedProfile('${r.id}', this)">‚ô•</button>`
                    : '';

                container.innerHTML += `
                <div class="recipe-mini">
                    ${heartHtml}
                    <div class="rm-img" style="${img ? `background-image:${img}; color:transparent;` : ''}">
                        ${img ? '' : placeholderText}
                    </div>
                    <div class="rm-body">
                        <div class="rm-title">${r.title}</div>
                        <div class="rm-meta">‚è± ${r.time_minutes} —Ö–≤</div>
                        ${actionsHtml}
                    </div>
                </div>
            `;
            });
        }

        // –≤–∏–¥–∞–ª–µ–Ω–Ω—è –≤–ª–∞—Å–Ω–æ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞
        async function deleteRecipe(id) {
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ä–µ—Ü–µ–ø—Ç –Ω–∞–∑–∞–≤–∂–¥–∏?')) return;
            const { error } = await supabase.from('recipes').delete().eq('id', id);
            if (error) {
                alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ —Ä–µ—Ü–µ–ø—Ç: ' + error.message);
                return;
            }
            if (currentUserId) {
                loadUserRecipes(currentUserId);
            }
        }

        // –≤—ñ–¥–∫—Ä—ñ–ø–∏—Ç–∏ —Ä–µ—Ü–µ–ø—Ç —ñ–∑ "–ó–±–µ—Ä–µ–∂–µ–Ω–∏—Ö" –ø–æ –∫–ª—ñ–∫—É –Ω–∞ —Å–µ—Ä–¥–µ—á–∫–æ
        async function toggleSavedProfile(recipeId, btn) {
            if (!currentUserId) return;
            const { error } = await supabase
                .from('saved_recipes')
                .delete()
                .match({ user_id: currentUserId, recipe_id: recipeId });

            if (error) {
                alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–µ: ' + error.message);
                return;
            }

            // –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –∫–∞—Ä—Ç–∫—É –≤ UI
            const card = btn.closest('.recipe-mini');
            if (card) card.remove();

            const container = document.getElementById('savedRecipesGrid');
            if (container && container.children.length === 0) {
                container.innerHTML = '<p style="color:#9ca3af;">–ü–æ–∫–∏ —â–æ –ø—É—Å—Ç–æ.</p>';
            }
        }

        // 6. –†–Ü–í–ï–ù–¨

        // –¥–æ–ø–æ–º—ñ–∂–Ω–∞: –ø–æ total XP —Ä–∞—Ö—É—î–º–æ —ñ–Ω–¥–µ–∫—Å —Ä—ñ–≤–Ω—è
        function getLevelIndex(totalXp) {
            let idx = Math.floor(totalXp / LEVEL_RANGE);
            if (idx < 0) idx = 0;
            if (idx >= LEVEL_NAMES.length) idx = LEVEL_NAMES.length - 1;
            return idx;
        }

        // –æ–Ω–æ–≤–ª–µ–Ω–Ω—è UI —Ä—ñ–≤–Ω—è –ø–æ total XP –∑ –±–∞–∑–∏
        function updateLevel(totalXp) {
            const levelIndex = getLevelIndex(totalXp);
            const levelName = LEVEL_NAMES[levelIndex];

            const xpInLevel = totalXp % LEVEL_RANGE;      // 0‚Äì999
            const xpToNext = LEVEL_RANGE - xpInLevel;     // —Å–∫—ñ–ª—å–∫–∏ –ª–∏—à–∏–ª–æ—Å—å –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ
            const percent = (xpInLevel / LEVEL_RANGE) * 100;

            document.getElementById('levelName').textContent = levelName;
            document.getElementById('levelXP').textContent = `${xpInLevel} / ${LEVEL_RANGE} XP`;
            document.getElementById('levelFill').style.width = `${Math.min(100, percent)}%`;

            const xpTextEl = document.getElementById('xpText');
            if (levelIndex === LEVEL_NAMES.length - 1) {
                xpTextEl.textContent = `–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ä—ñ–≤–µ–Ω—å! –ü—Ä–æ–¥–æ–≤–∂—É–π—Ç–µ –Ω–∞–±–∏—Ä–∞—Ç–∏ XP üòé`;
            } else {
                xpTextEl.textContent = `–©–µ ${xpToNext} XP –¥–æ –Ω–æ–≤–æ–≥–æ —Ä—ñ–≤–Ω—è.`;
            }
        }

        // üî• –ü–†–ò–†–û–°–¢ XP + –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è —Ä—ñ–≤–Ω—è
        // –í–∏–∫–ª–∏–∫–∞—î—à addXp(–∫—ñ–ª—å–∫—ñ—Å—Ç—å) —Ç–∞–º, –¥–µ —Ç—Ä–µ–±–∞ (–Ω–∞–ø—Ä. –ø—ñ—Å–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ä–µ—Ü–µ–ø—Ç–∞)
        async function addXp(amount) {
            if (!currentUserId || amount <= 0) return;

            // 1. –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π XP —é–∑–µ—Ä–∞
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('xp')
                .eq('id', currentUserId)
                .single();

            if (error) {
                console.error('XP load error', error);
                return;
            }

            const oldXp = profile?.xp || 0;
            const oldLevelIndex = getLevelIndex(oldXp);

            // 2. –†–∞—Ö—É—î–º–æ –Ω–æ–≤–∏–π XP
            const newXp = oldXp + amount;
            const newLevelIndex = getLevelIndex(newXp);

            // 3. –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ –±–∞–∑—É
            const { error: updateError } = await supabase
                .from('profiles')
                .update({
                    xp: newXp,
                    updated_at: new Date()
                })
                .eq('id', currentUserId);

            if (updateError) {
                console.error('XP update error', updateError);
                return;
            }

            // 4. –û–Ω–æ–≤–ª—é—î–º–æ UI
            updateLevel(newXp);

            // 5. –Ø–∫—â–æ —Ä—ñ–≤–µ–Ω—å –≤–∏—Ä—ñ—Å ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            if (newLevelIndex > oldLevelIndex) {
                const newLevelName = LEVEL_NAMES[newLevelIndex];
                alert(`–í—ñ—Ç–∞—î–º–æ! –í–∏ –¥–æ—Å—è–≥–ª–∏ —Ä—ñ–≤–Ω—è "${newLevelName}" üéâ`);
            }
        }

        function openTab(tabId, btn) {
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        async function logout() {
            await supabase.auth.signOut();
            window.location.href = "index.html";
        }
    </script>

</body>

</html>